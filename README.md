# Sample Unity Project with External Libraries

## Overview

This project is a demonstration of how to develop Unity games using Visual Studio that also include external libraries.

As mentioned earlier, we favor distributing source for shared libraries to our internal developers. We also favor performing unit tests on our libraries. Unit testing requires that we have separate unit test projects included in our solutions but that the unit test project libraries do not get included in the game. We also want to be able to develop our libraries independently of Unity, minimizing any dependency on the engine for shared code.

To make libraries testable, they are stored in VS projects outside the Unity root. The assemblies produced by these libraries are copied in a post-build step into `Assets/Binaries`.

## Project Structure (partial)

```
<VCS Root/Unity Root>

|-| <project>.sln 				Visual Studio solution for Unity project. Can be edited in VS.
|-| <project>.CSharp.csproj		Autogenerated project file for Unity .cs scripts. Don't edit.
|-| <project>.userprefs			Visual Studio project preferences. Created automatically don't version control

|-| Assets							Unity directory for developer content

|---| Libraries					Output directory for DLLs for libraries

|-----| lib_unity_<name>	Deployed directory for source and binaries of Unity libraries
|-------| Binaries			DLLs, MDBs and PDBs are deployed here
|-------| Assets				If one of the library projects contains Unity assets, they are copied here
|---------| Plugins			Following the Unity standard, plugins are copied here (if they are not pre-compiled)
|---------| Editor			Following the Unity standard Editor scripts are copied here (if they are not pre-compiled)
|---------| Resources		Following the Unity standard Resources like sound files are copied here
|-------| Samples				If sample files are included, they are copied here and have the same tree structure as ../Assets
|---------| Plugins			Following the Unity standard, plugins are copied here (if they are not pre-compiled)
|---------| Editor			Following the Unity standard Editor scripts are copied here (if they are not pre-compiled)
|---------| Resources		Following the Unity standard Resources like sound files are copied here

|-| Libraries 					Mobilityware standard folder for custom libraries

|---| lib_unity_<name>	Mobilityware custom library top-level folder

|-----| lib_unity_<name>.sln	Solution for the library when developed outside Unity
|-----| <project>				Class library project
|-------| <project>.csproj		Project file for the class library
|-------| bin/Debug			Folder for debug versions of libraries not included in Unity project
|-------| bin/Release		Folder for release versions of libraries not included in Unity project

|-----| <project>.Tests Unit tests for class library project
|-------| <project>.Tests.csproj		Project file for the tests for the class library

|-----| Samples					Separate "copy" project for sample code that does not get compiled. Instead it gets deployed with csproj copy
|-------| Samples.csproj	Samples project that deploys the

|-----| Assets					Separate "copy" project for required scripts that are not compiled into DLLs
|-------| Plugins				Following the Unity standard, plugins are copied here (if they are not pre-compiled)
|-------| Editor				Following the Unity standard Editor scripts are copied here (if they are not pre-compiled)
|-------| Resources			Following the Unity standard Resources like sound files are copied here
|-------| Assets.csproj	Samples project that deploys the

|-| packages						NuGet directory for downloaded packages like NUnit. 
```

### Samples

Some libraries may wish to include samples that exercise the functionality and provide template use-cases. Since this functionality is optional, it will be included in a separate project under the root of the library called `Samples`. This project is a `copy` project in the sense that the contents of the project will be copied into the Unity project hiearchy upon build but will not actually compile into a DLL.

### Assets

Like the `Samples` project, the `Assets` project is a `copy` project. The difference is that in this case, the contents of the project are expected to be mandatory for the use of the library. To the extent possible, `Assets` projects should be avoided in favor of compiling and deploying a DLL.

## Assumptions

You don't write `MonoBehaviours` in libraries!

`MonoBehaviours` are not unit testable. You cannot instantiate them directly. Rather than wrestle with this fact, accept it and simply avoid putting functionality into them. Instead, use something like the MVC pattern for Unity proposed [here](http://www.slideshare.net/paytonrules/tdd-in-unity?next_slideshow=1) and remove as much of the logic from your `MonoBehaviours` as possible and abstract them to libraries.

## Setting up your Visual Studio Library project

* For library (not test project) 
	* Create a C# class library
	* Set the target of the library to Unity 3.5 .net Subset
	* Add a post build step to copy the DLL (see below)
* For NUnit test project
	* Create the project from one of the "create project" menus, not the "add unit tests" menus
	* Create it using the NUnit 3 template
	* Name it <project>.Tests and place it in the same directory as <project>
	* Set the target for .NET 4.5
* Use the included Mobilityware Unity .gitignore file

## Setting up your project in Mono Develop

* For library (not test project) 
	* Create a C# class library
	* Set the target of the library to "Mono / .NET 3.5"
	* Add a post build step to copy the DLL (see below)
* For NUnit test project
	* Create the project from one of the "create project" menus
	* Add the MonoDevelop NUnit 2.x library
	* Manually include the project under test
	* Manually write unit tests
* Use the included Mobilityware Unity .gitignore file

## Post build event

This step requires modifying the `.csproj` file for the library in a text editor. This change will cause the binary outputs of the build, including the `.dll` and the `.pdb` in debug mode to be copied into `<Unity Root>/Assets/Binaries`. When Unity "sees" the `.pdb`, it will automatically create a matching `.mdb` for Mono debugging purposes.

```xml
  <ItemGroup>
          <Binaries Include="$(OutDir)**/*" />
  </ItemGroup>
  <Target Name="AfterBuild">
          <Copy SourceFiles="@(Binaries)" DestinationFolder="$(SolutionDir)Assets/Binaries"/>
          <Delete Files="$(SolutionDir)Assets/Binaries/UnityEngine.dll"/>
          <Delete Files="$(SolutionDir)Assets/Binaries/UnityEditor.dll"/>
  </Target>
```
